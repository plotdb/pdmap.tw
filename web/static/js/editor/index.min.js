!function(){var e,t,n,r,a,i,o,l,d,c;e={hover:{},scale:d3.interpolateSpectral,nameToFeature:{}},(t=new ldLoader({className:"ldld full z-fixed"})).on(),n={sheet:ld$.find(document,"#sheet",0),preview:ld$.find(document,"#preview",0)},r={activeSheet:"admin",sheets:a={admin:{order:{},data:[["縣市","鄉鎮","數值"]]},latlng:{order:{},data:[["緯度","經度","數值"]].concat(function(){var e,t=[];for(e=0;e<50;++e)i=e,t.push(["","",""]);return t}())}},random:function(){var t,n;return a.admin.data.map(function(e,t){if(t>0)return e[2]=Math.round(100*Math.random())}),a.latlng.data.map(function(e,t){if(t)return e[0]=3.2*Math.random()+23.89-1.6,e[1]=2.4*Math.random()+121-1.2,e[2]=Math.round(100*Math.random())}),t=Math.min.apply(null,a.latlng.data.map(function(e){return e[2]}).splice(1)),n=Math.max.apply(null,a.latlng.data.map(function(e){return e[2]}).splice(1)),e.rscale=d3.scaleSqrt().domain([t,n]).range([0,.3]),r.switch(r.activeSheet)},sort:function(e){var t,n,i,o,l;if(t=e.sheet,n=e.idx,i=e.isAscending,t=a[t||r.activeSheet])return o=t.order[n]=null!=i?i:!t.order[n],o=o?1:-1,l=t.data.splice(0,1)[0],t.data.sort(function(e,t){return o*(e[n]>t[n]?1:e[n]<t[n]?-1:0)}),t.data.splice(0,0,l),r.hot.render()},switch:function(e){var t,n,i;if(!e){n=[];for(i in a)n.push(i);e=(t=n)[(t.indexOf(r.activeSheet)+1)%t.length]}if(a[e])return r.activeSheet=e,r.hot.loadData(a[r.activeSheet].data),r.hot.render()},init:function(){return Handsontable.renderers.registerRenderer("myrenderer",function(e,t,n,r,a,i,o){Handsontable.renderers.TextRenderer.apply(this,arguments),0===n&&t.classList.add("head"),isNaN(i)}),r.hot=new Handsontable(n.sheet,{afterChange:function(){var t;return a.admin.data.map(function(t){if(e.nameToFeature[t[0]])return e.nameToFeature[t[0]][t[1]].properties.value=t[2]}),t=a.admin.data.map(function(e){return e[2]||0}).splice(1),e.max=Math.max.apply(null,t),e.min=Math.min.apply(null,t),l.render()},afterSelection:function(e,t,n,a){if(e===n&&0===n&&t===a&&a<3)return r.sort({idx:a})},data:a.admin.data,fixedRowsTop:1,rowHeaders:!0,colHeaders:!0,filters:!0,dropdownMenu:!0,stretchH:"all",rowHeights:25,minRows:50,minCols:10,cells:function(e,t){var n;return n={},n.renderer="myrenderer",0===e&&(n.readOnly=!0),n},customBorders:[{range:{from:{row:0,col:0},to:{row:0,col:99}},bottom:{width:2,color:"#000"}}]}),r.random()}},o={view:null,download:debounce(350,function(){if(null!=o.view)return o.view.render("download")}),init:function(){var e;return e=new ldView({root:document.body,handler:{download:function(e){var t,n,r;if(t=e.node,l.map&&l.map.root&&(n=ld$.find(l.map.root,"svg",0)),n)return n.setAttribute("xmlns","http://www.w3.org/2000/svg"),r=URL.createObjectURL(new Blob([n.outerHTML],{type:"text/svg+xml"})),t.setAttribute("href",r),t.setAttribute("download","map.svg"),t.classList.remove("disabled")}},action:{click:{toggle:function(t){var n;return n=t.node,r.switch(n.getAttribute("data-name")),e.getAll("toggle").map(function(e){return e.classList.remove("active")}),n.classList.add("active")},palette:function(e){return e.node,l.ldpp[0].get().then(function(e){return l.set("palette",e)})},random:function(e){return e.node,r.random()},"config-btn":function(){return e.get("config-panel").classList.toggle("invisible",!1),e.get("config-panel").classList.toggle("z-float",!0)},"data-btn":function(){return e.get("config-panel").classList.toggle("invisible",!0),e.get("config-panel").classList.toggle("z-float",!1)},int:function(t){var n;return n=t.names,d.int=n.filter(function(e){return"int"!==e})[0],e.get("int-name").innerText=d.int.toUpperCase(),l.render()}}}})}},l={map:null,ldpp:ldPalettePicker.init({ldcv:{},pals:ldPalettePicker.get("loadingio")}),set:function(e,t){if("palette"===e&&t)return d.pal=t.colors.map(function(e){return ldColor.hex(e)}),l.render()},render:function(){var t,n,r,i,c;return d.pal&&(t=(t=(t=d.pal.map(function(e,t){return t/(d.pal.length-1)})).map(function(e,t){return e*(2*d.coverage)+(d.midPoint-d.coverage)})).map(function(e){var t;return(t=e>0?e:0)<1?t:1}),n="hcl"===d.int?d3.interpolateHcl:"hsl"===d.int?d3.interpolateHsl:d3.interpolateRgb,e.scale=d3.scaleLinear().domain(t).range(d.pal).interpolate(n)),(r=d3.select(l.map.root)).selectAll("path").transition().duration(350).attr("fill",function(t){var n;return n=(t.properties.value-e.min)/(e.max-e.min||1),e.scale(n)}),r.select("g").selectAll("circle").data(a.latlng.data).enter().append("circle"),r.select("g").selectAll("circle").attr("fill",function(){return ldColor.hex(d.bubbleColor)}).attr("fill-opacity",.2).attr("cx",function(e,t,n){var r,a,i,o;return r=[e[0],e[1]],a=r[0],i=r[1],o=pdmaptw.projection([i,a])[0],isNaN(o)?0:o}).attr("cy",function(e,t,n){var r,a,i,o;return r=[e[0],e[1]],a=r[0],i=r[1],o=pdmaptw.projection([i,a])[1],isNaN(o)?0:o}).attr("r",function(t,n){var r;return r=e.rscale?e.rscale(t[2]):0,isNaN(r)?0:r}),t&&(i=+getComputedStyle(l.map.root).fontSize.replace(/[a-z]+$/,""),r.select("g.legend").selectAll("g").data(t).enter().append("g").each(function(e,t){return d3.select(this).append("text"),d3.select(this).append("rect")}),c=0,r.select("g.legend").selectAll("g").each(function(n,r){return c=t[r+1]===n?c:c+1,d3.select(this).attr("transform","translate("+.75*i+" "+(i+c*i*1.5)+")").style("display",t[r+1]===n?"none":"block"),d3.select(this).select("text").attr("x","1.75em").attr("y","1em").text(Math.round(100*(n*(e.max-e.min)+e.min))/100),d3.select(this).select("rect").attr("x",0).attr("y",0).attr("width","1.5em").attr("height","1em").attr("fill",e.scale(n))})),o.download()},init:function(){var i;return l.map=i=pdmaptw.create({root:n.preview,type:"town",baseurl:"/assets/lib/pdmaptw"}),i.init().then(function(){var n,o,d,c,s,u;return i.fit(),n=i.lc.meta.name,i.lc.features.map(function(t){var r,i,o;return r=[n[t.properties.c],n[t.properties.t]],i=r[0],o=r[1],a.admin.data.push([i,o]),((r=e.nameToFeature)[i]||(r[i]={}))[o]=t}),r.init(),o=ldPalettePicker.get("loadingio").filter(function(e){return e.colors.length>3}),l.set("palette",o[Math.floor(o.length*Math.random())]),d=ld$.find(l.map.root,"svg",0),c=ld$.find(document.body,"#popup",0),s=new ldView({root:c,handler:{name:function(t){var n;return n=t.node,n.innerText=e.hover.name||""},value:function(t){var n;return n=t.node,n.innerText=e.hover.value}}}),u=debounce(2e3,function(){return c.classList.add("ld","ld-fade-out")}),d.addEventListener("mouseover",function(t){var n,r,o,l,d,p,f,m,h,g,v,w,b,x;if((n=d3.select(t.target).datum())&&(r=i.lc.meta.name[n.properties.c],o=i.lc.meta.name[n.properties.t],l=a.admin.data.filter(function(e){return e[0]===r&&e[1]===o})[0]))return d=l[2],e.hover={name:r+""+o,value:d},s.render(),p=c.parentNode.getBoundingClientRect(),f=c.getBoundingClientRect(),m=[t.clientX-p.x,t.clientY-p.y],h=m[0],g=m[1],v=(h<p.width/2?1:-1)*((m=.05*p.width)>20?m:20),w=(g<p.height/2?1:-1)*((m=.05*p.height)>20?m:20),h>p.width/2&&(v-=f.width),g>p.height/2&&(w-=f.height),m=[h+v,g+w],b=m[0],x=m[1],c.style.transform="translate("+b+"px, "+x+"px)",c.classList.remove("ld","ld-fade-out","d-none"),u()}),d3.select(d).append("g").attr("class","legend"),t.off()})}},d={bubbleColor:"#000",midPoint:.5,coverage:.5,int:"hcl"},l.init(),o.init(),(c=new ldSlider({root:ld$.find("#slider-mid-point",0),min:0,max:100,step:.1,from:50})).set(50),c.on("change",function(e){return d.midPoint=e/100,l.render()}),(c=new ldSlider({root:ld$.find("#slider-coverage",0),min:0,max:100,step:.1,from:50})).set(50),c.on("change",function(e){return d.coverage=e/100*.8+.2,l.render()}),new ldColorPicker(picker).on("change",function(e){return d.bubbleColor=e,ld$.find("#picker div",0).style.background=ldColor.web(e),l.render()})}();